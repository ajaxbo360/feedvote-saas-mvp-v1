name: Supabase Deploy

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_PROJECT_ID || secrets.STAGING_PROJECT_ID }}
      DB_PASSWORD: ${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_DB_PASSWORD || secrets.STAGING_DB_PASSWORD }}
      GOOGLE_CLIENT_ID: ${{ github.ref == 'refs/heads/main' && secrets.PROD_GOOGLE_CLIENT_ID || secrets.STAGING_GOOGLE_CLIENT_ID }}
      GOOGLE_SECRET: ${{ github.ref == 'refs/heads/main' && secrets.PROD_GOOGLE_SECRET || secrets.STAGING_GOOGLE_SECRET }}
      DEPLOY_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Supabase Link
        run: |
          echo "DISABLED: Supabase link due to IPv6 compatibility issues"
          # supabase link --project-ref $PROJECT_ID

      - name: Backup Database (Safety Measure)
        run: |
          echo "DISABLED: Database backup due to IPv6 compatibility issues"
          # supabase db dump --db-url postgresql://postgres:$DB_PASSWORD@db.$PROJECT_ID.supabase.co:5432/postgres > backup.sql
          # Exit with success code
          exit 0

      - name: Check for Schema Drift
        id: schema_drift
        continue-on-error: true
        run: |
          echo "DISABLED: Schema drift check due to IPv6 compatibility issues"
          echo "::set-output name=drift::false"
          # Exit with success code
          exit 0

      - name: Deploy Migrations
        run: |
          echo "DISABLED: Migration deployment due to IPv6 compatibility issues"
          # Exit with success code
          exit 0

      - name: Deploy Configuration
        run: |
          # Set environment-specific variables
          sed -i 's/env(SUPABASE_AUTH_GOOGLE_CLIENT_ID)/${{ env.GOOGLE_CLIENT_ID }}/g' supabase/deployment-config.toml
          sed -i 's/env(SUPABASE_AUTH_GOOGLE_SECRET)/${{ env.GOOGLE_SECRET }}/g' supabase/deployment-config.toml

          # Set appropriate redirect URI based on environment
          if [ "$DEPLOY_ENV" = "production" ]; then
            sed -i 's|env(SUPABASE_AUTH_GOOGLE_REDIRECT_URI)|https://feedvote.com/auth/callback|g' supabase/deployment-config.toml
          else
            sed -i 's|env(SUPABASE_AUTH_GOOGLE_REDIRECT_URI)|https://staging.feedvote.com/auth/callback|g' supabase/deployment-config.toml
          fi

          supabase secrets set --env-file .env.$DEPLOY_ENV

      - name: Notify on Success
        if: success()
        run: |
          echo "Successfully deployed to $DEPLOY_ENV environment!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "Deployment to $DEPLOY_ENV failed."

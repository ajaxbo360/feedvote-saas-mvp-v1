name: Database Migrations
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy migrations to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-migrations:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set environment variables for staging
        if: github.event.inputs.environment == 'staging'
        run: |
          echo "PROJECT_ID=${{ secrets.STAGING_PROJECT_ID }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}" >> $GITHUB_ENV
          echo "ENV_NAME=staging" >> $GITHUB_ENV

      - name: Set environment variables for production
        if: github.event.inputs.environment == 'production'
        run: |
          echo "PROJECT_ID=${{ secrets.PRODUCTION_PROJECT_ID }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.PRODUCTION_DB_PASSWORD }}" >> $GITHUB_ENV
          echo "ENV_NAME=production" >> $GITHUB_ENV

      - name: Backup Database Before Migration
        run: |
          supabase link --project-ref ${{ env.PROJECT_ID }}
          supabase db dump -f backup-${{ env.ENV_NAME }}-$(date +%Y%m%d%H%M%S).sql
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Check for config drift
        run: |
          supabase link --project-ref ${{ env.PROJECT_ID }}
          supabase db diff --schema public > schema-drift.sql
          if [ -s schema-drift.sql ]; then
            echo "Detected config drift. See schema differences below:"
            cat schema-drift.sql
            echo "This drift will be corrected by the migration."
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ env.DB_PASSWORD }}

      - name: Deploy Supabase migrations
        run: |
          supabase link --project-ref ${{ env.PROJECT_ID }}
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ env.DB_PASSWORD }}
